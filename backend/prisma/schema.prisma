// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Users & Authentication
// ============================================

enum UserRole {
  SR  // Sales Representative
  SUP // Supervisor
  SM  // Sales Manager
  PM  // Product Manager
  MM  // Marketing Manager
}

model Company {
  id              String   @id @default(uuid())
  name            String
  logoUrl         String?  @map("logo_url")
  settings        Json?
  storageUsedMb   Int      @default(0) @map("storage_used_mb")
  storageLimitMb  Int      @default(102400) @map("storage_limit_mb") // 100 GB
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  users           User[]

  @@map("companies")
}

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  email         String    @unique
  passwordHash  String?   @map("password_hash")
  fullName      String    @map("full_name")
  phone         String?
  role          UserRole
  managerId     String?   @map("manager_id")
  companyId     String    @map("company_id")
  territoryId   String?   @map("territory_id")
  googleId      String?   @unique @map("google_id")
  isActive      Boolean   @default(true) @map("is_active")
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager       User?     @relation("UserManager", fields: [managerId], references: [id])
  subordinates  User[]    @relation("UserManager")
  territory     Territory? @relation(fields: [territoryId], references: [id])

  preCallPlans       PreCallPlan[]
  callReports        CallReport[]
  approvedPlans      PreCallPlan[]    @relation("ApprovedBy")
  coachingRecords    CoachingRecord[]
  calendarEvents     CalendarEvent[]
  notifications      Notification[]
  customersCreated   Customer[]

  @@index([companyId])
  @@index([territoryId])
  @@index([managerId])
  @@map("users")
}

// ============================================
// Territories
// ============================================

model Territory {
  id          String   @id @default(uuid())
  code        String   @unique // BKK1, BKK2, CT1, etc.
  nameTh      String   @map("name_th")
  nameEn      String   @map("name_en")
  description String?
  provinces   Json?    // Array of province names
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       User[]
  customers   Customer[]

  @@map("territories")
}

// ============================================
// Customers & Contacts
// ============================================

enum CustomerType {
  A // VIP: > 500K/month
  B // Important: 100-500K/month
  C // Standard: < 100K/month
}

model Customer {
  id                     String        @id @default(uuid())
  code                   String        @unique
  name                   String
  type                   CustomerType
  monthlyRevenue         Decimal?      @map("monthly_revenue") @db.Decimal(12, 2)
  address                String?
  lat                    Decimal?      @db.Decimal(10, 8)
  lng                    Decimal?      @db.Decimal(11, 8)
  district               String?
  province               String?
  postalCode             String?       @map("postal_code")
  phone                  String?
  territoryId            String?       @map("territory_id")
  requiredVisitsPerMonth Int?          @map("required_visits_per_month")
  responseTimeHours      Int?          @map("response_time_hours")
  isActive               Boolean       @default(true) @map("is_active")
  createdBy              String        @map("created_by")
  sapCustomerCode        String?       @unique @map("sap_customer_code")
  sapSyncStatus          String?       @map("sap_sync_status")
  sapLastSync            DateTime?     @map("sap_last_sync")
  createdAt              DateTime      @default(now()) @map("created_at")
  updatedAt              DateTime      @updatedAt @map("updated_at")

  territory              Territory?    @relation(fields: [territoryId], references: [id])
  creator                User          @relation(fields: [createdBy], references: [id])

  contacts               Contact[]
  preCallPlans           PreCallPlan[]
  callReports            CallReport[]

  @@index([territoryId])
  @@index([type])
  @@index([createdBy])
  @@map("customers")
}

model Contact {
  id          String   @id @default(uuid())
  customerId  String   @map("customer_id")
  name        String
  position    String?
  phone       String?
  email       String?
  lineId      String?  @map("line_id")
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  preCallPlans PreCallPlan[]
  callReports  CallReport[]

  @@index([customerId])
  @@map("contacts")
}

// ============================================
// Pre-Call Planning
// ============================================

enum PlanStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

model PreCallPlan {
  id                 String      @id @default(uuid())
  srId               String      @map("sr_id")
  customerId         String      @map("customer_id")
  contactId          String      @map("contact_id")
  planDate           DateTime    @map("plan_date")
  objectives         String?
  plannedActivities  Json?       @map("planned_activities") // Array of activity IDs
  status             PlanStatus  @default(DRAFT)
  approvedBy         String?     @map("approved_by")
  approvedAt         DateTime?   @map("approved_at")
  rejectionReason    String?     @map("rejection_reason")
  comments           Json?       // Array of comment objects
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  sr                 User        @relation(fields: [srId], references: [id], onDelete: Cascade)
  customer           Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contact            Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  approver           User?       @relation("ApprovedBy", fields: [approvedBy], references: [id])

  callReports        CallReport[]

  @@index([srId])
  @@index([customerId])
  @@index([planDate])
  @@index([status])
  @@map("pre_call_plans")
}

// ============================================
// Call Reports
// ============================================

enum CallActivityType {
  VIRTUAL
  FACE_TO_FACE
}

enum CallReportStatus {
  DRAFT
  SUBMITTED
}

model CallReport {
  id                String            @id @default(uuid())
  preCallPlanId     String?           @map("pre_call_plan_id")
  srId              String            @map("sr_id")
  customerId        String            @map("customer_id")
  contactId         String            @map("contact_id")
  callDate          DateTime          @map("call_date") @db.Date
  checkInTime       DateTime?         @map("check_in_time")
  checkInLat        Decimal?          @map("check_in_lat") @db.Decimal(10, 8)
  checkInLng        Decimal?          @map("check_in_lng") @db.Decimal(11, 8)
  checkOutTime      DateTime?         @map("check_out_time")
  checkOutLat       Decimal?          @map("check_out_lat") @db.Decimal(10, 8)
  checkOutLng       Decimal?          @map("check_out_lng") @db.Decimal(11, 8)
  callActivityType  CallActivityType? @map("call_activity_type")
  activitiesDone    Json?             @map("activities_done") // Array of activity IDs
  customerResponse  String?           @map("customer_response") @db.Text
  customerRequest   String?           @map("customer_request") @db.Text
  customerObjections String?          @map("customer_objections") @db.Text
  customerNeeds     String?           @map("customer_needs") @db.Text
  customerComplaints String?          @map("customer_complaints") @db.Text
  nextAction        String?           @map("next_action") @db.Text
  status            CallReportStatus  @default(DRAFT)
  isPlanned         Boolean           @default(false) @map("is_planned")
  durationMinutes   Int?              @map("duration_minutes")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  preCallPlan       PreCallPlan?      @relation(fields: [preCallPlanId], references: [id])
  sr                User              @relation(fields: [srId], references: [id], onDelete: Cascade)
  customer          Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contact           Contact           @relation(fields: [contactId], references: [id], onDelete: Cascade)

  photos            Photo[]
  coachingRecords   CoachingRecord[]

  @@index([srId])
  @@index([customerId])
  @@index([callDate])
  @@index([status])
  @@map("call_reports")
}

// ============================================
// Photos
// ============================================

enum PhotoCategory {
  PRODUCT
  POP_POSM
  CUSTOMER
  ACTIVITY
  OTHER
}

model Photo {
  id            String        @id @default(uuid())
  callReportId  String        @map("call_report_id")
  category      PhotoCategory
  url           String
  thumbnailUrl  String?       @map("thumbnail_url")
  lat           Decimal?      @db.Decimal(10, 8)
  lng           Decimal?      @db.Decimal(11, 8)
  timestamp     DateTime
  metadata      Json?         // Camera info, dimensions, etc.
  sizeBytes     BigInt        @map("size_bytes")
  createdAt     DateTime      @default(now()) @map("created_at")

  callReport    CallReport    @relation(fields: [callReportId], references: [id], onDelete: Cascade)

  @@index([callReportId])
  @@index([category])
  @@map("photos")
}

// ============================================
// Activities (Master Data)
// ============================================

model ActivityType {
  id            String   @id @default(uuid())
  code          String   @unique
  nameTh        String   @map("name_th")
  nameEn        String   @map("name_en")
  category      String?
  requiresPhoto Boolean  @default(false) @map("requires_photo")
  isActive      Boolean  @default(true) @map("is_active")
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("activity_types")
}

// ============================================
// Coaching & Comments
// ============================================

model CoachingRecord {
  id            String     @id @default(uuid())
  callReportId  String     @map("call_report_id")
  managerId     String     @map("manager_id")
  comments      String     @db.Text
  rating        Int?       // 1-5
  coachingPoints Json?     @map("coaching_points")
  createdAt     DateTime   @default(now()) @map("created_at")

  callReport    CallReport @relation(fields: [callReportId], references: [id], onDelete: Cascade)
  manager       User       @relation(fields: [managerId], references: [id])

  @@index([callReportId])
  @@index([managerId])
  @@map("coaching_records")
}

// ============================================
// Calendar
// ============================================

enum EventType {
  PRE_CALL_PLAN
  MEETING
  TRAINING
  LEAVE
  OTHER
}

model CalendarEvent {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  title       String
  eventType   EventType @map("event_type")
  referenceId String?   @map("reference_id") // ID of PreCallPlan or other entity
  startDate   DateTime  @map("start_date")
  endDate     DateTime  @map("end_date")
  allDay      Boolean   @default(false) @map("all_day")
  location    String?
  notes       String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startDate])
  @@map("calendar_events")
}

// ============================================
// Notifications
// ============================================

enum NotificationType {
  PLAN_APPROVED
  PLAN_REJECTED
  PLAN_PENDING
  REMINDER
  COACHING
  SYSTEM
}

model Notification {
  id            String           @id @default(uuid())
  userId        String           @map("user_id")
  type          NotificationType
  title         String
  message       String           @db.Text
  referenceType String?          @map("reference_type")
  referenceId   String?          @map("reference_id")
  isRead        Boolean          @default(false) @map("is_read")
  createdAt     DateTime         @default(now()) @map("created_at")

  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// ============================================
// SAP Integration (Future)
// ============================================

enum SyncStatus {
  PENDING
  SUCCESS
  FAILED
}

model SapSyncLog {
  id            String     @id @default(uuid())
  entityType    String     @map("entity_type") // customer, call_report, order, etc.
  entityId      String     @map("entity_id")
  action        String     // create, update, delete
  status        SyncStatus
  sapResponse   Json?      @map("sap_response")
  errorMessage  String?    @map("error_message") @db.Text
  retryCount    Int        @default(0) @map("retry_count")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  @@index([entityType, entityId])
  @@index([status])
  @@map("sap_sync_logs")
}
